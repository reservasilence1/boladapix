<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bolada Pix</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f4;--card:#fff;--borda:#e8ebea;
      --verde:#42761d;--sub:#6b776a;--txt:#1f2a1e
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .topoShell{max-width:880px;margin:0 auto;background:#fff;border-radius:0 0 14px 14px;box-shadow:0 6px 18px rgba(15,23,42,.12)}
    .topoBarra{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #e5e7eb}
    .btnVoltar{width:32px;height:32px;border-radius:999px;border:none;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .btnVoltar svg{width:18px;height:18px;stroke:#111827}
    .topoLogo{height:34px}
    .topoBanner img{width:100%;display:block}
    .wrapper{max-width:880px;margin:16px auto 28px;padding:0 16px}
    .breadcrumb{max-width:720px;margin:0 auto 10px;color:var(--sub);font-size:13px;display:flex;gap:8px}
    .breadcrumb a{text-decoration:none;color:var(--sub)}
    .card{max-width:720px;margin:0 auto;background:#fff;border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .tituloSecao{font-size:18px;font-weight:700;margin-bottom:14px}
    .topRow{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8faf7;border:1px solid var(--borda);border-radius:10px}
    .small{font-size:13px;color:var(--sub)}
    .method{margin-top:12px;display:flex;justify-content:space-between;align-items:center;border:2px solid #2563eb;background:#eef3ff;border-radius:12px;padding:14px}
    .radio{width:20px;height:20px;border-radius:50%;background:#2563eb}
    .upsellBox{margin-top:18px;border:1px solid #e4e7ec;border-radius:10px;overflow:hidden}
    .upsellTitle{background:#f7931a;color:#fff;padding:12px;text-align:center;font-weight:600}
    .upsellContent{display:flex;align-items:center;gap:10px;padding:14px}
    .upsellCheckbox{width:20px;height:20px}
    .summary{margin-top:18px;border-top:1px solid var(--borda);padding-top:12px}
    .total{font-weight:800;font-size:18px}
    .cotas{font-size:15px;margin-top:6px}
    .btn{width:100%;height:48px;border-radius:10px;border:0;background:var(--verde);color:#fff;font-weight:800;margin-top:18px;cursor:pointer}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.6);display:none;align-items:center;justify-content:center;z-index:999}
    .overlay.show{display:flex}
    .loader{width:46px;height:46px;border:4px solid #cfe0ca;border-top-color:var(--verde);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<div class="topoShell">
  <div class="topoBarra">
    <button class="btnVoltar" onclick="history.back()">‚Üê</button>
    <img src="/pagamento/images/logoboladapix.png" class="topoLogo">
    <div style="width:32px"></div>
  </div>
  <div class="topoBanner">
    <img src="/pagamento/images/bannerboladapix.webp">
  </div>
</div>

<div class="wrapper">
  <div class="breadcrumb">
    <span>Escolher Produto</span> ‚Ä∫ <span>Dados pessoais</span> ‚Ä∫ <strong>Pagamento</strong>
  </div>

  <div class="card">
    <div class="tituloSecao">M√©todo de pagamento</div>

    <div class="topRow">
      <div>
        <div id="nomeBox" style="font-weight:700"></div>
        <div id="cpfBox" class="small"></div>
      </div>
    </div>

    <div class="method">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="radio"></span>
        <div>
          <strong>Pix</strong>
          <div class="small">Aprova√ß√£o imediata</div>
        </div>
      </div>
    </div>

    <div class="upsellBox">
      <div class="upsellTitle">Aumente suas chances üòÅ</div>
      <label class="upsellContent">
        <input type="checkbox" id="upsellCheck" class="upsellCheckbox">
        <span>Leve +20 n√∫meros por R$ 9,98</span>
      </label>
    </div>

    <div class="summary">
      <div class="total">Total: <span id="valorTotal"></span></div>
      <div class="cotas">N√∫meros: <span id="qtdCotas"></span></div>
    </div>

    <button id="confirmar" class="btn">Confirmar compra</button>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="loader"></div>
</div>

<script>
  /* CONFIG */
  const VALOR_UNIT_CENT = 59; // R$ 0,59 fixo
  const UPS_COTAS = 20;
  const UPS_VALOR_CENT = 998;

  const cliente = JSON.parse(localStorage.getItem("cliente") || "{}");
  const cotasBase = Number(localStorage.getItem("cotas") || 0);

  function brl(v){return "R$ " + (v/100).toFixed(2).replace(".",",")}

  const nomeBox = document.getElementById("nomeBox");
  const cpfBox = document.getElementById("cpfBox");
  const valorEl = document.getElementById("valorTotal");
  const cotasEl = document.getElementById("qtdCotas");
  const ups = document.getElementById("upsellCheck");

  nomeBox.textContent = cliente.nome || "";
  cpfBox.textContent = "CPF: ***.***.***-" + String(cliente.cpf).slice(-2);

  function atualizar(){
    const extra = ups.checked;
    const cotas = cotasBase + (extra ? UPS_COTAS : 0);
    const valor = cotasBase * VALOR_UNIT_CENT + (extra ? UPS_VALOR_CENT : 0);

    cotasEl.textContent = cotas;
    valorEl.textContent = brl(valor);

    cliente.cotas = cotas;
    cliente.valor = valor / 100;
    localStorage.setItem("cliente", JSON.stringify(cliente));
  }

  atualizar();
  ups.addEventListener("change", atualizar);

  document.getElementById("confirmar").onclick = async ()=>{
    document.getElementById("overlay").classList.add("show");
    const payload = {
      amount: Math.round(cliente.valor * 100),
      paymentMethod:"PIX",
      customer:{
        name:cliente.nome,
        document:String(cliente.cpf).replace(/\D/g,"")
      }
    };
    const r = await fetch("/api/pix",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const j = await r.json();
    if(j?.pix?.qrcode){
      localStorage.setItem("pix",JSON.stringify(j));
      location.href="/pagamento/payment.html"+location.search;
    }else alert("Erro ao gerar PIX");
  };
</script>

</body>
</html>
