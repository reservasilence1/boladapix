<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bolada Pix</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root { --bg:#f3f5f4; --card:#fff; --borda:#e8ebea; --verde:#42761d; --sub:#6b776a; --txt:#1f2a1e }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
.topoShell{max-width:880px;margin:0 auto;background:#fff;border-radius:0 0 14px 14px;box-shadow:0 6px 18px rgba(15,23,42,.12)}
.topoBarra{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #e5e7eb}
.btnVoltar{width:32px;height:32px;border-radius:999px;border:none;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer}
.btnVoltar svg{width:18px;height:18px;stroke:#111827}
.topoLogo{height:47px}
.topoSpacer{width:32px;height:32px}
.topoBanner{width:100%;border-radius:0 0 14px 14px;overflow:hidden}
.topoBanner img{display:block;width:100%;height:auto}
.wrapper{max-width:880px;margin:16px auto 28px;padding:0 16px}
.breadcrumb{max-width:720px;margin:0 auto 10px auto;color:var(--sub);font-size:13px;display:flex;align-items:center;gap:8px}
.breadcrumb a{color:var(--sub);text-decoration:none}
.breadcrumb span.sep{opacity:.6}
.card{max-width:720px;margin:0 auto;background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
.tituloSecao{font-size:18px;font-weight:700;color:#111827;margin-bottom:14px}
.topRow{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8faf7;border:1px solid var(--borda);border-radius:10px;margin-bottom:16px}
.userBox{display:flex;flex-direction:column}
.small{font-size:13px;color:var(--sub)}
.link{color:#1a73e8;text-decoration:none;font-size:13px}
.method{display:flex;align-items:center;justify-content:space-between;border:2px solid #2563eb;background:#eef3ff;border-radius:12px;padding:14px;margin-top:4px}
.method .left{display:flex;align-items:center;gap:12px}
.radio{width:20px;height:20px;border-radius:999px;border:2px solid #2563eb;background:radial-gradient(circle at center,#2563eb 55%,#fff 55%);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
.summary{margin-top:18px;border-top:1px solid var(--borda);padding-top:12px}
.total{font-weight:800;font-size:18px;color:#111}
.cotas{font-size:15px;color:#111;margin-top:6px}
.btn{width:100%;height:48px;border-radius:10px;border:0;background:var(--verde);color:#fff;font-weight:800;cursor:pointer;margin-top:18px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
.btn:disabled{opacity:.7;cursor:not-allowed}
.spin{width:18px;height:18px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:g 1s linear infinite;display:none}
.btn.loading .spin{display:inline-block}
@keyframes g{to{transform:rotate(360deg)}}
.cookies{max-width:560px;margin:14px auto 0 auto;text-align:center;color:var(--sub);font-size:12px}
.rodapeLogo{display:flex;justify-content:center;margin-top:10px}
.rodapeLogo img{height:75px;opacity:.9}
.overlay{position:fixed;inset:0;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);display:none;align-items:center;justify-content:center;z-index:9999}
.overlay.show{display:flex}
.loader{width:46px;height:46px;border:4px solid #cfe0ca;border-top-color:var(--verde);border-radius:50%;animation:g 1s linear infinite}
.upsellBox{margin-top:18px;border:1px solid #e4e7ec;border-radius:10px;overflow:hidden;background:#fff}
.upsellTitle{background:#f7931a;color:#fff;font-weight:600;padding:12px;text-align:center;font-size:15px}
.upsellContent{display:flex;align-items:center;gap:10px;padding:14px;cursor:pointer}
.upsellText{font-size:15px;font-weight:600;color:#1f2a1e}
.upsellCheckbox{appearance:none;width:20px;height:20px;border:2px solid #d0d5dd;border-radius:4px;background:#fff;cursor:pointer}
.upsellCheckbox:checked{background:#f7931a;border-color:#f7931a}
</style>
</head>

<body>

<script>
window.pixelId="695b5d30537d4a93ecc52183";
var a=document.createElement("script");
a.async=true;a.defer=true;
a.src="https://cdn.utmify.com.br/scripts/pixel/pixel.js";
document.head.appendChild(a);
</script>

<div class="topoShell">
  <div class="topoBarra">
    <button class="btnVoltar" onclick="history.back()">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15.75 19.5 8.25 12l7.5-7.5" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <img src="/pagamento/images/logoboladapix.png" class="topoLogo">
    <div class="topoSpacer"></div>
  </div>
  <div class="topoBanner">
    <img src="/pagamento/images/bannerboladapix.webp">
  </div>
</div>

<div class="wrapper">
  <div class="card">
    <div class="tituloSecao">M√©todo de pagamento</div>

    <div class="topRow">
      <div class="userBox">
        <div id="nomeBox" style="font-weight:700"></div>
        <div id="cpfBox" class="small"></div>
      </div>
      <a id="trocar" class="link">N√£o √© voc√™?</a>
    </div>

    <div class="method">
      <div class="left">
        <span class="radio"></span>
        <div>
          <div style="font-weight:700">Pix</div>
          <div class="small">Aprova√ß√£o imediata</div>
        </div>
      </div>
    </div>

    <div class="upsellBox">
      <div class="upsellTitle">Aumente suas chances üòÅ</div>
      <label class="upsellContent">
        <input type="checkbox" id="upsellCheck" class="upsellCheckbox">
        <span class="upsellText">Leve + 20 Bilhetes por R$ 9,98</span>
      </label>
    </div>

    <div class="summary">
      <div class="total">Total: <span id="valorTotal"></span></div>
      <div class="cotas">Cotas: <span id="qtdCotas"></span></div>
    </div>

    <button id="confirmar" class="btn">
      <span class="spin"></span>
      <span class="t">Confirmar compra</span>
    </button>
  </div>
</div>

<div class="cookies">
  Usamos cookies para melhorar a sua navega√ß√£o. Ao usar nosso site voc√™ concorda com o uso de cookies descrito na nossa
  <a href="#" style="color:var(--verde);text-decoration:none">Pol√≠tica de Privacidade</a>
</div>
<div class="rodapeLogo">
  <img src="/pagamento/images/logoboladapix.png" alt="Logo">
</div>

<div id="overlay" class="overlay"><div class="loader"></div></div>

<script>
/* ================= CONFIG ================= */
const PRECO_UNIT = 0.59;
const DESCONTO_LIMITE = 200;
const DESCONTO = 0.34;

const UPS_VALOR = 9.98;     // valor EXTRA do upsell (sempre soma no total quando marcado)
const UPS_COTAS = 20;       // bilhetes extra (continua somando na contagem)

/* ================= DADOS ================= */
const cliente = JSON.parse(localStorage.getItem("cliente") || "{}");
let cotasBase = Number(localStorage.getItem("cotas") || 0);

/* ================= UI ================= */
document.getElementById("nomeBox").textContent = cliente.nome || "";
document.getElementById("cpfBox").textContent = "CPF: " + (cliente.cpf || "");

/* ================= FUN√á√ïES ================= */
function brl(v){ return "R$ " + Number(v).toFixed(2).replace(".", ","); }

/* Valor base de cotas SEM upsell e COM regra de desconto >200 */
function calcularValor(qtd){
  let total = qtd * PRECO_UNIT;
  if (qtd > DESCONTO_LIMITE) total *= (1 - DESCONTO);
  return total;
}

/*
  ‚úÖ Ajuste pedido:
  - O upsell fica "oculto" no sentido de N√ÉO receber desconto.
  - Ou seja: primeiro calcula o total das cotas (com desconto se >200),
    depois SOMA +9,98 fixo por fora quando marcar.
*/
function atualizar(){
  const ups = document.getElementById("upsellCheck").checked;

  const cotas = cotasBase + (ups ? UPS_COTAS : 0);

  const totalCotas = calcularValor(cotas);           // pre√ßo do produto (com desconto se >200)
  const totalFinal = totalCotas + (ups ? UPS_VALOR : 0); // ‚úÖ upsell sempre soma R$9,98 "por fora"

  document.getElementById("valorTotal").textContent = brl(totalFinal);
  document.getElementById("qtdCotas").textContent = String(cotas);

  // salva correto pra etapa do PIX
  cliente.valor = totalFinal;
  cliente.cotas = cotas;
  localStorage.setItem("cliente", JSON.stringify(cliente));
}

atualizar();
document.getElementById("upsellCheck").addEventListener("change", atualizar);

document.getElementById("trocar").addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.removeItem("cliente");
  location.href = "index.html";
});

/* ================== BOT√ÉO CONFIRMAR (mant√©m seu fluxo, s√≥ garante total correto) ================== */
const btn = document.getElementById("confirmar");
const overlay = document.getElementById("overlay");
let travado = false;

function paramsToObj() {
  const p = new URLSearchParams(window.location.search);
  const o = {};
  p.forEach((v, k) => (o[k] = v));
  return o;
}

function normalizePhoneBR(phone) {
  const d = String(phone || "").replace(/\D/g, "");
  if (!d) return "";
  if (d.length >= 12 && d.startsWith("55")) return d;
  if (d.length >= 10 && d.length <= 11) return "55" + d;
  return d;
}

function buildUtmString(trackingObj) {
  const keys = Object.keys(trackingObj || {});
  const utmPairs = [];
  for (const k of keys) {
    if (/^utm_/i.test(k)) {
      utmPairs.push(encodeURIComponent(k) + "=" + encodeURIComponent(String(trackingObj[k])));
    }
  }
  return utmPairs.join("&");
}

btn.addEventListener("click", async () => {
  if (travado) return;

  // garante que o total salvo est√° atualizado
  atualizar();

  travado = true;
  btn.disabled = true;
  btn.classList.add("loading");
  btn.querySelector(".t").textContent = "Gerando pagamento...";
  overlay.classList.add("show");

  try {
    const tracking = paramsToObj();
    const totalCent = Math.round((cliente.valor || 0) * 100);

    const payload = {
      amount: totalCent,
      description: "Pagamento via Pix",
      customer: {
        name: cliente.nome,
        document: String(cliente.cpf || "").replace(/\D/g, ""),
        email: cliente.email,
        phone: normalizePhoneBR(cliente.celular),
      },
      item: {
        title: "Pedido - Bolada Pix",
        price: totalCent,
        quantity: 1,
      },
      paymentMethod: "PIX",
      utm: buildUtmString(tracking),
    };

    const res = await fetch("/api/pix", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const j = await res.json();

    const pixCode = j?.pix?.qrcode || j?.pixCode || j?.pixcode || j?.qrCode;

    if (pixCode) {
      localStorage.setItem("pix", JSON.stringify(j));
      window.location.href = "/pagamento/payment.html" + window.location.search;
    } else {
      alert("N√£o foi poss√≠vel gerar o PIX.");
    }
  } catch (e) {
    alert("Erro ao gerar pagamento.");
  } finally {
    overlay.classList.remove("show");
    btn.classList.remove("loading");
    btn.querySelector(".t").textContent = "Confirmar compra";
    btn.disabled = false;
    travado = false;
  }
});
</script>

</body>
</html>
